# UI设计文档 - 背包界面

> 像《逃离塔科夫》/《背包乱斗》风格的不规则网格背包系统

---

## 界面布局

```
┌──────────────────────────────────────────────────────────────────────┐
│                                                                      │
│                          背包界面                                    │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │                        背包区域                                 │  │
│  │  ┌───┬───┬───┬───┬───┬───┬───┬───┐                            │  │
│  │  │💊│   │   │📷│📷│   │   │   │  ← 不规则物品占用多格          │  │
│  │  ├───┼───┼───┼───┼───┼───┼───┼───┤                            │  │
│  │  │🔫│🔫│   │📷│📷│   │📦│📦│                            │  │
│  │  ├───┼───┼───┼───┼───┼───┼───┼───┤                            │  │
│  │  │   │   │📔│   │   │   │📦│📦│                            │  │
│  │  ├───┼───┼───┼───┼───┼───┼───┼───┤                            │  │
│  │  │   │   │   │   │   │   │   │   │                            │  │
│  │  ├───┼───┼───┼───┼───┼───┼───┼───┤                            │  │
│  │  │🎯│🎯│🎯│🎯│   │   │   │   │  ← 大物品占用4格(2x2)          │  │
│  │  ├───┼───┼───┼───┼───┼───┼───┼───┤                            │  │
│  │  │🎯│🎯│🎯│🎯│   │   │   │   │                            │  │
│  │  └───┴───┴───┴───┴───┴───┴───┴───┘                            │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  快捷栏 (拖拽道具到此处)                                        │  │
│  │  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐                       │  │
│  │  │   1   │ │   2   │ │   3   │ │   4   │                       │  │
│  │  │  💊   │ │  🔫   │ │       │ │  📦   │                       │  │
│  │  └───────┘ └───────┘ └───────┘ └───────┘                       │  │
│  │    [1]      [2]      [3]      [4]    ← 按键使用                 │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
│                    [ESC/点击外部 关闭]                               │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 核心机制

### 1. 不规则物品尺寸

| 尺寸 | 占格 | 示例物品 |
|------|------|----------|
| **小** | 1x1 (1格) | 药丸💊、钥匙🔑、硬币 |
| **中** | 1x2 (2格) | 手电筒🔦、水壶 |
| **大** | 2x2 (4格) | 相机📷、盒子📦 |
| **特殊** | 2x3 (6格) | 大型物品🎯 |

### 2. 快捷栏机制

```
操作流程:
1. 打开背包界面
2. 从背包区域拖拽道具
3. 放到快捷栏 1/2/3/4 格子上
4. 道具"拓印"到该快捷位 (背包中道具不移除)

拓印 = 引用关系
- 快捷栏只是指向背包中道具的"快捷方式"
- 使用快捷栏道具 = 使用背包中该道具
- 道具用完后，快捷栏自动清空
```

### 3. 拾取检测

```
玩家拾取道具时:

1. 获取道具尺寸 (例如 2x2)
2. 扫描背包网格
3. 寻找可容纳该尺寸的连续空格区域
4. 找到 → 自动放入第一个可用位置
5. 未找到 → 提示"背包已满"
```

### 4. 网格检测算法

```javascript
// 检测是否能放下指定尺寸的物品
function canPlaceItem(width, height) {
  const backpack = getBackpackGrid();  // 背包网格

  for (let y = 0; y <= backpack.rows - height; y++) {
    for (let x = 0; x <= backpack.cols - width; x++) {
      if (canPlaceAt(x, y, width, height)) {
        return { x, y };  // 返回可放置位置
      }
    }
  }
  return null;  // 无法放置
}

function canPlaceAt(startX, startY, width, height) {
  const backpack = getBackpackGrid();

  for (let y = startY; y < startY + height; y++) {
    for (let x = startX; x < startX + width; x++) {
      if (backpack.grid[y][x] !== null) {
        return false;  // 有物品占用
      }
    }
  }
  return true;  // 可以放置
}
```

---

## 交互设计

### 拖拽操作
```
鼠标/触摸操作:
1. 按住物品 → 物品跟随光标
2. 移动到目标位置
3. 释放 → 尝试放置
4. 位置有效 → 放置成功
5. 位置无效 → 物品返回原位
```

### 旋转物品 (可选)
```
按 R 键 → 旋转物品 (1x2 ↔ 2x1)
```

### 快捷栏绑定
```
拖拽物品到快捷栏:
- 如果快捷栏已有物品 → 替换
- 物品仍在背包中，快捷栏只是"拓印"
```

---

## 数据结构

```javascript
// 背包物品
const backpackItem = {
  id: 1,
  itemId: 101,        // 关联的物品定义ID
  name: "运动相机",
  size: { w: 2, h: 2 }, // 占用2x2格子
  position: { x: 3, y: 0 }, // 在背包中的位置
  rotation: 0         // 0 或 90 (旋转角度)
};

// 快捷栏
const quickSlots = [
  { backpackItemId: 1 },  // 指向背包物品ID
  { backpackItemId: 5 },
  null,                   // 空
  { backpackItemId: 3 }
];

// 背包网格
const backpackGrid = {
  cols: 8,
  rows: 6,
  grid: [
    [1, null, null, 2, 2, null, null, null],  // 1=物品ID, null=空
    [3, 3, null, 2, 2, null, 4, 4],
    // ...
  ]
};
```

---

## 视觉反馈

### 可放置区域高亮
```
拖拽物品时:
- 绿色高亮 → 可以放置
- 红色高亮 → 无法放置 (被占用/超出边界)
```

### 背包已满提示
```
┌─────────────────────┐
│    ⚠️ 背包已满      │
│                     │
│  无法放入该物品     │
│                     │
│    [ 确定 ]         │
└─────────────────────┘
```

### 物品信息悬浮
```
鼠标悬停物品时:
┌─────────────────────┐
│  运动相机           │
│  ─────────────────  │
│  尺寸: 2x2          │
│  技能: 抓拍照片     │
│  ─────────────────  │
│  闪光照相机的回忆...│
└─────────────────────┘
```

---

## 技术实现优先级

| 优先级 | 功能 | 复杂度 |
|--------|------|--------|
| P0 | 背包网格基础显示 | 中 |
| P0 | 物品放置/移除 | 中 |
| P1 | 拖拽交互 | 高 |
| P1 | 拾取自动检测 | 中 |
| P1 | 快捷栏绑定 | 中 |
| P2 | 物品旋转 | 低 |
| P2 | 放置高亮反馈 | 中 |
| P2 | 悬浮信息框 | 低 |
